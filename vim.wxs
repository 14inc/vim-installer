<?xml version='1.0' encoding='utf-8'?>
<Wix xmlns='http://schemas.microsoft.com/wix/2006/wi'>

  <!-- require $(env.VER_FULL) $(env.VER_SHORT) $(env.FEAT_OLE) -->

  <?define ProductVersion = "$(env.VER_FULL)"?>

  <!-- FIXME: Add version number? -->
  <?define ProductName = "Vim"?>

  <?define StartMenuName = "Vim $(env.VER_SHORT)"?>

  <Product
    Id='*'
    UpgradeCode='1BE1251B-E89C-D54B-A192-7617BE4014E1'
    Language='$(var.lang)'
    Codepage='$(var.codepage)'
    Version='$(var.ProductVersion)'
    Name='$(var.ProductName)'
    Manufacturer='Vim Developers'
    >

    <Package Id="*" Compressed='yes' />

    <!-- All product having same UpgradeCode will be overridden. -->
    <MajorUpgrade AllowDowngrades="yes" />

    <Property Id="ARPCOMMENTS">Vi Improved - A Text Editor</Property>
    <Property Id="ARPURLINFOABOUT">http://www.vim.org/</Property>
    <Property Id="ARPPRODUCTICON">vim.ico</Property>

    <Icon Id="vim.ico" SourceFile="vim\src\vim.ico" />

    <Media Id='1' Cabinet='product.cab' EmbedCab='yes' CompressionLevel="high" />

    <Directory Id='TARGETDIR' Name='SourceDir'>
      <Directory Id='ProgramFilesFolder'>
        <Directory Id='INSTALLDIR' Name='$(var.ProductName)'>
        </Directory>
      </Directory>
      <Directory Id="ProgramMenuFolder">
        <Directory Id="ApplicationProgramsFolder" Name="$(var.StartMenuName)">
        </Directory>
      </Directory>
      <Directory Id="DesktopFolder" />
    </Directory>

    <DirectoryRef Id="INSTALLDIR">
      <Component Id="gvim.exe" Guid="*">
        <File Id="gvim.exe" KeyPath="yes" Source="$(var.dist)\gvim.exe">

          <!-- FIXME: How to separate Component to make TypeLib register optional? -->
          <?if $(env.FEAT_OLE) = 1?>
          <!--
            This component installs OLE typelib (Same as gvim.exe -register).
            TypeLib and Interface are generated by "heat.exe file vim\src\vim.tlb".
            See vim\src\if_ole.idl for id.
          -->
          <!-- HKCR\TypeLib\{Id} -->
          <TypeLib Id="{0F0BFAE0-4C90-11D1-82D7-0004AC368519}" Description="Vim OLE Interface 1.1 Type Library" Language="0" MajorVersion="1" MinorVersion="1" HelpDirectory="INSTALLDIR">
            <!-- HKCR\Interface\{Id} -->
            <Interface Id="{0F0BFAE2-4C90-11D1-82D7-0004AC368519}" Name="IVim" ProxyStubClassId="{00020424-0000-0000-C000-000000000046}" ProxyStubClassId32="{00020424-0000-0000-C000-000000000046}" />
            <!-- HKCR\CLSID\{Id} -->
            <Class Id="{0F0BFAE1-4C90-11d1-82D7-0004AC368519}" Context="LocalServer32" Version="Vim.Application.1">
              <!-- HKCR\{id} -->
              <ProgId Id="Vim.Application.1">
                <ProgId Id="Vim.Application" />
              </ProgId>
            </Class>
          </TypeLib>
          <?endif?>

        </File>
      </Component>
    </DirectoryRef>

    <DirectoryRef Id="INSTALLDIR">
      <Component Id="gvimext.dll" Guid="*">
        <File Id="gvimext.dll" KeyPath="yes" Source="$(var.dist)\gvimext.dll">
          <Class Id="{51EEE242-AD87-11d3-9C1E-0090278BBD99}" Description="Vim Shell Extension" Context="InprocServer32" ThreadingModel="apartment">
          </Class>
        </File>
        <RegistryValue Root='HKCR' Key='*\shellex\ContextMenuHandlers\gvim' Type="string" Value="{51EEE242-AD87-11d3-9C1E-0090278BBD99}" />
        <RegistryValue Root='HKLM' Key='Software\Microsoft\Windows\CurrentVersion\Shell Extensions\Approved' Name="{51EEE242-AD87-11d3-9C1E-0090278BBD99}" Type="string" Value="Vim Shell Extension" />
        <!-- used by gvimext.dll -->
        <RegistryValue Root='HKLM' Key='Software\Vim\Gvim' Name="path" Type="string" Value="[INSTALLDIR]gvim.exe" />
      </Component>
    </DirectoryRef>

    <DirectoryRef Id="INSTALLDIR">
      <Component Id="OpenWith" Guid="*">
        <RegistryValue Root='HKCR' Key='Applications\gvim.exe\shell\edit\command' Type="string" Value='"[INSTALLDIR]gvim.exe" "%1"' KeyPath="yes" />
        <RegistryValue Root='HKCR' Key='*\OpenWithList\gvim.exe' Type="string" Value="" />
        <RegistryValue Root='HKCR' Key='.vim\OpenWithList\gvim.exe' Type="string" Value="" />
        <RegistryValue Root='HKCR' Key='.htm\OpenWithList\gvim.exe' Type="string" Value="" />
      </Component>
    </DirectoryRef>

    <DirectoryRef Id="INSTALLDIR">
      <Component Id="PathEnvironment" Guid="147EA001-A6FF-6146-BACB-86277994D96B">
        <Environment Id='UpdatePath' Name='PATH' Action='set' Permanent='no' System='yes' Part='last' Value='[INSTALLDIR]' />
        <RegistryValue Root='HKLM' Key='Software\Vim\install' Name="install_path_environment" Type="string" Value="1" KeyPath="yes" />
      </Component>
    </DirectoryRef>

    <DirectoryRef Id="ApplicationProgramsFolder">
      <Component Id="StartMenu" Guid="538BB2EB-05F2-E042-879A-7992638CB319">
        <Shortcut Id="StartMenu1" Name="Vim" Target="[INSTALLDIR]vim.exe" WorkingDirectory="INSTALLDIR" />
        <Shortcut Id="StartMenu2" Name="Vim Read-only" Target="[INSTALLDIR]vim.exe" Arguments="-R" WorkingDirectory="INSTALLDIR" />
        <Shortcut Id="StartMenu3" Name="Vim Diff" Target="[INSTALLDIR]vim.exe" Arguments="-d" WorkingDirectory="INSTALLDIR" />
        <Shortcut Id="StartMenu4" Name="gVim" Target="[INSTALLDIR]gvim.exe" WorkingDirectory="INSTALLDIR" />
        <Shortcut Id="StartMenu5" Name="gVim Easy" Target="[INSTALLDIR]gvim.exe" Arguments="-y" WorkingDirectory="INSTALLDIR" />
        <Shortcut Id="StartMenu6" Name="gVim Read-only" Target="[INSTALLDIR]gvim.exe" Arguments="-R" WorkingDirectory="INSTALLDIR" />
        <Shortcut Id="StartMenu7" Name="gVim Diff" Target="[INSTALLDIR]gvim.exe" Arguments="-d" WorkingDirectory="INSTALLDIR" />
        <Shortcut Id="StartMenu8" Name="Uninstall" Target="[SystemFolder]msiexec.exe" Arguments="/x [ProductCode]" />
        <Shortcut Id="StartMenu9" Name="Vim tutor" Target="[INSTALLDIR]vimtutor.bat" WorkingDirectory="INSTALLDIR" />
        <Shortcut Id="StartMenu10" Name="Help" Target="[INSTALLDIR]gvim.exe" Arguments="-c h" WorkingDirectory="INSTALLDIR" />
        <IniFile Id="StartMenu11" Action="addLine" Name="Vim Online.url" Directory="ApplicationProgramsFolder" Section="InternetShortcut" Key="URL" Value="http://vim.sf.net/" />
        <RemoveFolder Id='ApplicationProgramsFolder' On='uninstall' />
        <RegistryValue Root='HKCU' Key='Software\Vim\install' Name="install_startmenu" Type="string" Value="1" KeyPath="yes" />
      </Component>
    </DirectoryRef>

    <DirectoryRef Id="DesktopFolder">
      <Component Id="DesktopShortcut" Guid="F07119B3-1959-A44D-BEC7-94B4EAA2B57B">
        <Shortcut Id="DesktopShortcut1" Name="gVim" Target="[INSTALLDIR]gvim.exe" WorkingDirectory="INSTALLDIR" />
        <Shortcut Id="DesktopShortcut2" Name="gVim Easy" Target="[INSTALLDIR]gvim.exe" Arguments="-y" WorkingDirectory="INSTALLDIR" />
        <Shortcut Id="DesktopShortcut3" Name="gVim Read only" Target="[INSTALLDIR]gvim.exe" Arguments="-R" WorkingDirectory="INSTALLDIR" />
        <RegistryValue Root='HKCU' Key='Software\Vim\install' Name="install_desktop_shortcut" Type="string" Value="1" KeyPath="yes" />
      </Component>
    </DirectoryRef>

    <Feature Id='Complete' Title='!(loc.Feature_Complete_Title)' Description='!(loc.Feature_Complete_Description)' Display='expand' Level='1' ConfigurableDirectory='INSTALLDIR'>
      <ComponentGroupRef Id='MainFiles' />
      <ComponentRef Id="gvim.exe" />
      <Feature Id="StartMenu" Title="!(loc.Feature_StartMenu_Title)" Description="!(loc.Feature_StartMenu_Description)" Level="1">
        <ComponentRef Id="StartMenu" />
      </Feature>
      <Feature Id="DesktopShortcut" Title="!(loc.Feature_DesktopShortcut_Title)" Description="!(loc.Feature_DesktopShortcut_Description)" Level="1">
        <ComponentRef Id="DesktopShortcut" />
      </Feature>
      <Feature Id="Popup" Title="!(loc.Feature_Popup_Title)" Description="!(loc.Feature_Popup_Description)" Level="1">
        <ComponentRef Id="gvimext.dll" />
      </Feature>
      <Feature Id="OpenWith" Title="!(loc.Feature_OpenWith_TItle)" Description="!(loc.Feature_OpenWith_Description)" Level="1">
        <ComponentRef Id="OpenWith" />
      </Feature>
      <Feature Id="PathEnvironment" Title="!(loc.Feature_PathEnvironment_Title)" Description="!(loc.Feature_PathEnvironment_Description)" Level="1">
        <ComponentRef Id="PathEnvironment" />
      </Feature>
    </Feature>

    <WixVariable Id="WixUIBannerBmp" Value="bitmaps\bannrbmp.bmp" />
    <WixVariable Id="WixUIDialogBmp" Value="bitmaps\dlgbmp.bmp" />
    <WixVariable Id="WixUILicenseRtf" Value="vimlicense.rtf" />

    <UIRef Id="WixUI_Mondo" />
    <UIRef Id="WixUI_ErrorProgressText" />

    <Property Id="MyScript">
      <![CDATA[
      Function Rec(msg)
        Set oRec = Installer.CreateRecord(0)
        oRec.StringData(0) = msg
        Set Rec = oRec
      End Function
      Function UpgradeWarning()
        msg = Session.FormatRecord(Rec("!(loc.UpgradeWarning)"))
        Session.Message &H03000000, Rec(msg)
      End Function
      ]]>
    </Property>

    <CustomAction Id="UpgradeWarning" Property="MyScript" VBScriptCall="UpgradeWarning" />

    <UI>
      <InstallUISequence>
        <Custom Action="UpgradeWarning" After="FindRelatedProducts">WIX_UPGRADE_DETECTED</Custom>
      </InstallUISequence>
    </UI>

  </Product>
</Wix>
